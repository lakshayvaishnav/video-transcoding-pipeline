// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UploadStatus {
  PENDING
  UPLOADED
  PROCESSING
  COMPLETED
  FAILED
}

enum JobStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum OutputType {
  HLS_MASTER
  HLS_VARIANT
  MP4
  THUMBNAIL
  POSTER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String // Hashed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  uploads Upload[]

  @@map("users")
}

model Upload {
  id          String       @id @default(uuid())
  userId      String
  objectKey   String       @unique // S3 key
  filename    String // Original filename
  contentType String
  size        BigInt
  status      UploadStatus @default(PENDING)
  metadata    Json? // Additional metadata
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs TranscodeJob[]

  @@index([userId])
  @@index([status])
  @@map("uploads")
}

model TranscodeJob {
  id             String    @id @default(uuid())
  uploadId       String
  status         JobStatus @default(PENDING)
  attempts       Int       @default(0)
  maxAttempts    Int       @default(3)
  priority       Int       @default(0)
  profiles       Json // Array of transcode profiles
  outputPrefix   String // S3 prefix for outputs
  idempotencyKey String?   @unique
  progress       Int       @default(0) // 0-100
  error          Json? // Error details if failed
  startedAt      DateTime?
  finishedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  upload  Upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  outputs Output[]

  @@index([uploadId])
  @@index([status])
  @@index([createdAt])
  @@map("transcode_jobs")
}

model Output {
  id          String     @id @default(uuid())
  jobId       String
  type        OutputType
  path        String // S3 key
  profileName String? // e.g., "1080p", "720p"
  resolution  String? // e.g., "1920x1080"
  bitrate     Int? // in bps
  size        BigInt?
  duration    Float? // in seconds
  manifestUrl String? // For HLS master playlist
  createdAt   DateTime   @default(now())

  job TranscodeJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([type])
  @@map("outputs")
}
